rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // === USUARIOS ===
    // CRUD completo para su propio perfil
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // === SERVICIOS ===
    // âœ… NAVEGACIÃ“N PÃšBLICA: Cualquiera puede explorar servicios
    // ğŸ”’ GESTIÃ“N PRIVADA: Solo el propietario puede crear/modificar sus servicios
    match /services/{serviceId} {
      allow read: if true; // ğŸ“– Lectura pÃºblica para navegaciÃ³n
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.providerId; // ğŸ” Solo usuarios autenticados
      allow update, delete: if request.auth != null && 
                           request.auth.uid == resource.data.providerId; // ğŸ” Solo el propietario
      
      // === RESEÃ‘AS DE SERVICIOS ===
      // SubcolecciÃ³n para reseÃ±as y puntuaciones
      match /reviews/{reviewId} {
        allow read: if true; // ğŸ“– Cualquiera puede leer reseÃ±as
        allow create: if request.auth != null && 
                     request.auth.uid == request.resource.data.userId && // ğŸ” Solo usuarios autenticados
                     request.auth.uid != get(/databases/$(database)/documents/services/$(serviceId)).data.providerId; // ğŸš« No auto-reseÃ±as
        allow update, delete: if request.auth != null && 
                             request.auth.uid == resource.data.userId; // ğŸ” Solo el autor de la reseÃ±a
      }
      
      // === IMÃGENES DE SERVICIOS ===
      // Metadatos de imÃ¡genes (las imÃ¡genes reales van en Storage)
      match /images/{imageId} {
        allow read: if true; // ğŸ“– Cualquiera puede ver metadatos de imÃ¡genes
        allow write: if request.auth != null && 
                    request.auth.uid == get(/databases/$(database)/documents/services/$(serviceId)).data.providerId; // ğŸ” Solo el propietario del servicio
      }
    }
    
    // === CATEGORÃAS DE SERVICIOS ===
    // âœ… NAVEGACIÃ“N PÃšBLICA: Cualquiera puede ver categorÃ­as
    // ğŸ”’ GESTIÃ“N ADMIN: Solo administradores pueden modificar
    match /categories/{categoryId} {
      allow read: if true; // ğŸ“– Lectura pÃºblica para navegaciÃ³n
      allow write: if false; // ğŸ” Solo administradores (desde backend/consola)
    }
    
    // === NOTIFICACIONES ===
    // Sistema de notificaciones para usuarios
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
                 request.auth.uid == resource.data.userId; // ğŸ” Solo el destinatario
      allow write: if false; // ğŸ” Solo el sistema puede crear notificaciones
    }
    
    // === CONFIGURACIÃ“N GLOBAL ===
    // ConfiguraciÃ³n pÃºblica de la aplicaciÃ³n
    match /app_config/{configId} {
      allow read: if true; // ğŸ“– ConfiguraciÃ³n pÃºblica (tÃ©rminos, contacto, etc.)
      allow write: if false; // ğŸ” Solo administradores desde backend
    }
    
    // === UBICACIONES ===
    // Cache de ubicaciones para mejorar rendimiento
    match /locations/{locationId} {
      allow read: if true; // ğŸ“– Lectura pÃºblica para bÃºsquedas geogrÃ¡ficas
      allow write: if false; // ğŸ” Solo el sistema puede gestionar ubicaciones
    }
    
    // === REPORTES ===
    // Sistema de reportes para servicios/usuarios problemÃ¡ticos
    match /reports/{reportId} {
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.reporterId; // ğŸ” Solo usuarios autenticados pueden reportar
      allow read, update, delete: if false; // ğŸ” Solo administradores desde backend
    }
    
    // ğŸš« Denegar acceso a todo lo demÃ¡s por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}