rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // === USUARIOS ===
    // CRUD completo para su propio perfil
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && 
                  request.auth.uid == userId &&
                  // ğŸ–¼ï¸ Validar URL de imagen de perfil (si se actualiza)
                  (!request.resource.data.keys().hasAny(['profileImageUrl']) || 
                   request.resource.data.profileImageUrl == null || 
                   request.resource.data.profileImageUrl.matches('https://firebasestorage.googleapis.com/.*'));
    }
    
    // === SERVICIOS ===
    // âœ… NAVEGACIÃ“N PÃšBLICA: Cualquiera puede explorar servicios
    // ğŸ”’ GESTIÃ“N PRIVADA: Solo el propietario puede crear/modificar sus servicios
    match /services/{serviceId} {
      allow read: if true; // ğŸ“– Lectura pÃºblica para navegaciÃ³n
      
      // âœ… CREAR SERVICIO: Validaciones robustas para nuevos servicios
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.providerId && // ğŸ” Solo usuarios autenticados
                   // ğŸ“‹ Validar campos obligatorios
                   request.resource.data.keys().hasAll(['title', 'description', 'category', 'price', 'providerId']) &&
                   request.resource.data.title is string && request.resource.data.title.size() > 5 &&
                   request.resource.data.description is string && request.resource.data.description.size() > 10 &&
                   request.resource.data.category is string && request.resource.data.category.size() > 0 &&
                   request.resource.data.price is number && request.resource.data.price >= 0 &&
                   // ğŸ–¼ï¸ Validar que las URLs de imÃ¡genes sean de Firebase Storage (si existen)
                   (!request.resource.data.keys().hasAny(['mainImage']) || 
                    request.resource.data.mainImage == null || 
                    request.resource.data.mainImage.matches('https://firebasestorage.googleapis.com/.*')) &&
                   (!request.resource.data.keys().hasAny(['images']) || 
                    request.resource.data.images is list);
      
      // âœ… ACTUALIZAR/ELIMINAR SERVICIO: Solo el propietario
      allow update, delete: if request.auth != null && 
                           request.auth.uid == resource.data.providerId && // ğŸ” Solo el propietario
                           // ğŸ–¼ï¸ Validar URLs de imÃ¡genes en actualizaciones (si se modifican)
                           (!request.resource.data.keys().hasAny(['mainImage']) || 
                            request.resource.data.mainImage == null || 
                            request.resource.data.mainImage.matches('https://firebasestorage.googleapis.com/.*')) &&
                           (!request.resource.data.keys().hasAny(['images']) || 
                            request.resource.data.images is list);
      
      // === RESEÃ‘AS DE SERVICIOS ===
      // SubcolecciÃ³n para reseÃ±as y puntuaciones
      match /reviews/{reviewId} {
        allow read: if true; // ğŸ“– Cualquiera puede leer reseÃ±as
        allow create: if request.auth != null && 
                     request.auth.uid == request.resource.data.userId && // ğŸ” Solo usuarios autenticados
                     request.auth.uid != get(/databases/$(database)/documents/services/$(serviceId)).data.providerId; // ğŸš« No auto-reseÃ±as
        allow update, delete: if request.auth != null && 
                             request.auth.uid == resource.data.userId; // ğŸ” Solo el autor de la reseÃ±a
      }
      
      // === IMÃGENES DE SERVICIOS ===
      // Metadatos de imÃ¡genes (las imÃ¡genes reales van en Storage)
      match /images/{imageId} {
        allow read: if true; // ğŸ“– Cualquiera puede ver metadatos de imÃ¡genes
        allow write: if request.auth != null && 
                    request.auth.uid == get(/databases/$(database)/documents/services/$(serviceId)).data.providerId; // ğŸ” Solo el propietario del servicio
      }
    }
    
    // === CATEGORÃAS DE SERVICIOS ===
    // âœ… NAVEGACIÃ“N PÃšBLICA: Cualquiera puede ver categorÃ­as
    // ğŸ”’ GESTIÃ“N ADMIN: Solo administradores pueden modificar
    match /categories/{categoryId} {
      allow read: if true; // ğŸ“– Lectura pÃºblica para navegaciÃ³n
      allow write: if false; // ğŸ” Solo administradores (desde backend/consola)
    }
    
    // === NOTIFICACIONES ===
    // Sistema de notificaciones para usuarios
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
                 request.auth.uid == resource.data.userId; // ğŸ” Solo el destinatario
      allow write: if false; // ğŸ” Solo el sistema puede crear notificaciones
    }
    
    // === CONFIGURACIÃ“N GLOBAL ===
    // ConfiguraciÃ³n pÃºblica de la aplicaciÃ³n
    match /app_config/{configId} {
      allow read: if true; // ğŸ“– ConfiguraciÃ³n pÃºblica (tÃ©rminos, contacto, etc.)
      allow write: if false; // ğŸ” Solo administradores desde backend
    }
    
    // === UBICACIONES ===
    // Cache de ubicaciones para mejorar rendimiento
    match /locations/{locationId} {
      allow read: if true; // ğŸ“– Lectura pÃºblica para bÃºsquedas geogrÃ¡ficas
      allow write: if false; // ğŸ” Solo el sistema puede gestionar ubicaciones
    }
    
    // === REPORTES ===
    // Sistema de reportes para servicios/usuarios problemÃ¡ticos
    match /reports/{reportId} {
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.reporterId; // ğŸ” Solo usuarios autenticados pueden reportar
      allow read, update, delete: if false; // ğŸ” Solo administradores desde backend
    }
    
    // ğŸš« Denegar acceso a todo lo demÃ¡s por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}