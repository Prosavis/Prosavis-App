rules_version = '2';

// 游댠 FIREBASE STORAGE SECURITY RULES
// Reglas para gesti칩n de im치genes y archivos

service firebase.storage {
  match /b/{bucket}/o {
    
    // === FUNCIONES HELPER ===
    function isSignedIn() {
      return request.auth != null;
    }
    function isServiceOwnerById(serviceId) {
      return isSignedIn() 
        && firestore.exists(/databases/(default)/documents/services/$(serviceId))
        && request.auth.uid == firestore.get(/databases/(default)/documents/services/$(serviceId)).data.providerId;
    }
    
    // === IM츼GENES DE PERFIL ===
    match /profile_images/{fileName} {
      allow read: if true;

      allow create, update: if isSignedIn()
        && fileName.matches('.*' + request.auth.uid + '.*')
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType != null
        && request.resource.contentType.matches('image/.*');

      // Solo due침o (sin an칩nimo)
      allow delete: if isSignedIn() && fileName.matches('.*' + request.auth.uid + '.*');
    }

    // === IM츼GENES DE SERVICIOS ===
    // M치s permisivo: permite subir im치genes a usuarios autenticados
    match /service_images/{fileName} {
      allow read: if true;

      // Crear/actualizar im치genes m치s permisivo
      allow create, update: if isSignedIn()
        && request.resource != null
        && request.resource.contentType != null
        && request.resource.contentType.matches('image/(jpeg|png|webp|jpg)')
        && request.resource.size < 10 * 1024 * 1024;

      // Borrado para usuarios autenticados
      allow delete: if isSignedIn()
        && (fileName.matches('.*' + request.auth.uid + '.*') 
            || (resource.metadata != null && resource.metadata.serviceId != null && isServiceOwnerById(resource.metadata.serviceId))
            || (fileName.matches('.*_.*') && firestore.exists(/databases/(default)/documents/services/$(fileName.split('_')[0])) && request.auth.uid == firestore.get(/databases/(default)/documents/services/$(fileName.split('_')[0])).data.providerId));
    }
    
    // === DOCUMENTOS Y CERTIFICADOS ===
    // Evita SVG (XSS) en documents
    match /documents/{userId}/{fileName} {
      allow read, write: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.size < 2 * 1024 * 1024
        && (
          request.resource.contentType.matches('application/pdf')
          || (
            request.resource.contentType.matches('image/.*')
            && !request.resource.contentType.matches('image/svg\\+xml')
          )
        );
    }
    
    // 游뛂 Denegar acceso a todo lo dem치s por defecto
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}